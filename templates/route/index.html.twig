{% extends 'base.html.twig' %}

{% block navigation_title %}Routes{% endblock %}

{% block navigation_buttons %}
{% include 'button/angle.html.twig' %}
{% if app.user %}
<button @click="location.href='{{ path('route_new') }}'" class="relative rounded-full p-1 text-emerald-200 hover:text-white focus:outline-2 focus:outline-offset-2 focus:outline-white">
    <span class="absolute -inset-1.5"></span>
    <span class="sr-only">Add Route</span>
    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
</button>
{% endif %}
{% include 'button/filter.html.twig' %}
{% endblock %}

{% block main %}
<div class="mx-auto max-w-2xl pb-12">
    <script>
        function initRouteList()
        {
            return {
                routes: {{ routes|json_encode|raw }}.map((route) => {
                    route['created_at'] = new Date(route['created_at'].date);
                    return route;
                }),
                filteredRoutes: [],
                init() {
                    {% for index, route in routes %}
                        this.routes[{{ index }}]['link'] = "{{ path('route_view', {id: route.id}) }}";
                    {% endfor %}
                    this.updateFilteredRoutes();
                },
                grades: {{ grades|json_encode|raw }},
                accRatings: {{ acc_ratings|json_encode|raw }},
                accGrades: {{ acc_grades|json_encode|raw }},
                logCounts: {{ log_counts|json_encode|raw }},
                {% if app.user %}
                userCounts: {{ user_counts|json_encode|raw }},
                {% endif %}
                angle: Alpine.$persist(0),
                observeAngle(event) {
                    this.angle = event.detail;
                    this.updateFilteredRoutes();
                },
                getRouteGradeIndex(id) {
                    if (this.accGrades.hasOwnProperty(id) && this.accGrades[id].hasOwnProperty(this.angle)) {
                        return this.grades.indexOf(this.accGrades[id][this.angle]);
                    }
                    return -1;
                },
                getRouteRating(id) {
                    if (this.accRatings.hasOwnProperty(id) && this.accRatings[id].hasOwnProperty(this.angle)) {
                        return this.accRatings[id][this.angle];
                    }
                    return -1;
                },
                getRouteLogCount(id) {
                    if (this.logCounts.hasOwnProperty(id) && this.logCounts[id].hasOwnProperty(this.angle)) {
                        return this.logCounts[id][this.angle];
                    }
                    return -1;
                },
                getAccentsText(id) {
                    const routeLogCount = this.getRouteLogCount(id);
                    let result = (routeLogCount > 0 ? routeLogCount : 0) + ' accents';
                    if ('userCounts' in this && this.userCounts.hasOwnProperty(id) && this.userCounts[id].hasOwnProperty(this.angle)) {
                        result += ' (' + (this.userCounts[id][this.angle][0] + this.userCounts[id][this.angle][1]) + ' by you)';
                    }
                    return result;
                },
                hasUserSend(id, isMirrored = false) {
                    return 'userCounts' in this && this.userCounts.hasOwnProperty(id) && this.userCounts[id].hasOwnProperty(this.angle) && this.userCounts[id][this.angle][isMirrored ? 1 : 0] > 0;
                },
                updateFilteredRoutes() {
                    const lowerName = this.name.toLowerCase();
                    const minGradeIndex = this.grades.indexOf(this.minGrade);
                    const maxGradeIndex = this.grades.indexOf(this.maxGrade);
                    this.filteredRoutes = this.routes.filter((route) => {
                        if (this.name != "" && !route.name.toLowerCase().includes(lowerName)) {
                            return false;
                        }
                        const routeGradeIndex = this.getRouteGradeIndex(route.id);
                        if (routeGradeIndex === -1) {
                            if (this.exclUngraded) {
                                return false;
                            }
                        } else if (routeGradeIndex < minGradeIndex || routeGradeIndex > maxGradeIndex){
                            return false;
                        }
                        const routeRating = this.getRouteRating(route.id);
                        if (routeRating === -1) {
                            if (this.exclUnrated) {
                                return false;
                            }
                        } else if (routeRating < this.minRating || routeRating > this.maxRating) {
                            return false;
                        }
                        {% if app.user %}
                            if (this.userSent == 'sent' && !this.hasUserSend(route.id) && !this.hasUserSend(route.id, true)) {
                                return false;
                            }
                            if (this.userSent == 'notsent' && (this.hasUserSend(route.id) || this.hasUserSend(route.id, true))) {
                                return false;
                            }
                            if (this.userSent == 'sentboth' && !(this.hasUserSend(route.id) && this.hasUserSend(route.id, true))) {
                                return false;
                            }
                            if (this.userSent == 'onlyone' && this.hasUserSend(route.id) == this.hasUserSend(route.id, true)) {
                                return false;
                            }
                        {% endif %}
                        return true;
                    }).sort((a, b) => {
                        if (this.sortBy == 'newest' || this.sortBy == 'oldest') {
                            var factor = 1;
                            if (this.sortBy == 'oldest') {
                                factor = -1;
                            }
                            if (a['created_at'] < b['created_at']) {
                                return 1 * factor;
                            } else if (a['created_at'] > b['created_at']) {
                                return -1 * factor;
                            }
                            return 0;
                        }
                        if (this.sortBy == 'hardest' || this.sortBy == 'easiest') {
                            var factor = 1;
                            if (this.sortBy == 'easiest') {
                                factor = -1;
                            }
                            const aGradeIndex = this.getRouteGradeIndex(a.id);
                            const bGradeIndex = this.getRouteGradeIndex(b.id);
                            if (aGradeIndex < bGradeIndex) {
                                return 1 * factor;
                            } else if (aGradeIndex > bGradeIndex) {
                                return -1 * factor;
                            }
                            return 0;
                        }
                        if (this.sortBy == 'best' || this.sortBy == 'worst') {
                            var factor = 1;
                            if (this.sortBy == 'worst') {
                                factor = -1;
                            }
                            const aRating = this.getRouteRating(a.id);
                            const bRating = this.getRouteRating(b.id);
                            if (aRating < bRating) {
                                return 1 * factor;
                            } else if (aRating > bRating) {
                                return -1 * factor;
                            }
                            return 0;
                        }
                        if (this.sortBy == 'popular' || this.sortBy == 'unpopular') {
                            var factor = 1;
                            if (this.sortBy == 'unpopular') {
                                factor = -1;
                            }
                            const aCount = this.getRouteLogCount(a.id);
                            const bCount = this.getRouteLogCount(b.id);
                            if (aCount < bCount) {
                                return 1 * factor;
                            } else if (aCount > bCount) {
                                return -1 * factor;
                            }
                            return 0;
                        }
                    });
                },
                observeFilter($event) {
                    this.name = $event.detail.name;
                    this.minGrade = $event.detail.minGrade;
                    this.maxGrade = $event.detail.maxGrade;
                    this.sortBy = $event.detail.sortBy;
                    this.exclUngraded = $event.detail.exclUngraded;
                    this.minRating = $event.detail.minRating;
                    this.maxRating = $event.detail.maxRating;
                    this.exclUnrated = $event.detail.exclUnrated;
                    this.userSent = $event.detail.userSent;
                    this.updateFilteredRoutes();
                },
                name: Alpine.$persist(""),
                minGrade: Alpine.$persist("{{ grades[0].value }}"),
                maxGrade: Alpine.$persist("{{ grades[grades|length-1].value }}"),
                exclUngraded: Alpine.$persist(false),
                minRating: Alpine.$persist(1),
                maxRating: Alpine.$persist(5),
                exclUnrated: Alpine.$persist(false),
                userSent: Alpine.$persist(""),
                sortBy: Alpine.$persist("newest")
            }
        }
    </script>
    <ul x-data="initRouteList()" @filter.window="observeFilter" @angle.window="observeAngle" role="list" class="divide-y divide-gray-200 dark:divide-white/5">
        <template x-for="route in filteredRoutes" hidden>
            <li class="flex flex-wrap items-center justify-between gap-x-6 gap-y-4 py-5 flex-nowrap">
                <div class="overflow-auto">
                    <p class="text-sm/6 font-semibold text-gray-900 dark:text-white text-nowrap overflow-hidden text-ellipsis">
                        <a :href="route.link" class="hover:underline" x-text="route.name"></a>
                    </p>
                    <div class="mt-1 flex items-center gap-x-2 text-xs/5 text-gray-500 dark:text-gray-400">
                        <p x-text="route['route_setter'].user_identifier"></p>
                        <svg viewBox="0 0 2 2" class="size-0.5 fill-current">
                            <circle r="1" cx="1" cy="1" />
                        </svg>
                        <p><time :datetime="route['created_at'].toISOString()" x-text="route['created_at'].toDateString()"></time></p>
                        <div class="flex items-center gap-x-2" x-show="accRatings.hasOwnProperty(route['id']) && accRatings[route['id']].hasOwnProperty(angle)" x-cloak>
                            <svg viewBox="0 0 2 2" class="size-0.5 fill-current">
                                <circle r="1" cx="1" cy="1" />
                            </svg>
                            <div class="flex items-center">
                                <template x-for="i in 5">
                                    <span :class="{'text-yellow-400': accRatings[route['id']][angle] >= i ,'text-gray-500 dark:text-gray-400': accRatings[route['id']][angle] < i}">
                                        <svg viewBox="0 0 16 16" fill="currentColor" class="size-4">
                                            <path fill-rule="evenodd" d="M8 1.75a.75.75 0 0 1 .692.462l1.41 3.393 3.664.293a.75.75 0 0 1 .428 1.317l-2.791 2.39.853 3.575a.75.75 0 0 1-1.12.814L7.998 12.08l-3.135 1.915a.75.75 0 0 1-1.12-.814l.852-3.574-2.79-2.39a.75.75 0 0 1 .427-1.318l3.663-.293 1.41-3.393A.75.75 0 0 1 8 1.75Z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                    <p class="mt-1 flex items-center gap-x-2 text-xs/5 text-gray-500 dark:text-gray-400">
                        <span x-text="getAccentsText(route['id'])"></span>
                        <svg viewBox="0 0 16 16" fill="currentColor" class="size-4" x-show="hasUserSend(route['id'])" x-cloak>
                            <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
                        </svg>
                        <svg viewBox="0 0 16 16" fill="currentColor" class="size-4" x-show="hasUserSend(route['id'], true)" x-cloak>
                            <path fill-rule="evenodd" d="M10.47 2.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H5.75a.75.75 0 0 1 0-1.5h5.69l-.97-.97a.75.75 0 0 1 0-1.06Zm-4.94 6a.75.75 0 0 1 0 1.06l-.97.97h5.69a.75.75 0 0 1 0 1.5H4.56l.97.97a.75.75 0 1 1-1.06 1.06l-2.25-2.25a.75.75 0 0 1 0-1.06l2.25-2.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                        </svg>
                    </p>
                </div>
                <div class="w-auto" x-show="accGrades.hasOwnProperty(route['id']) && accGrades[route['id']].hasOwnProperty(angle)" x-cloak>
                    <p class="text-sm/6 text-gray-900 dark:text-white" x-text="accGrades[route['id']][angle]"></p>
                </div>
            </li>
        </template>
    </ul>
</div>
{% endblock %}